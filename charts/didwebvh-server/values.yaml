---
nameOverride: "didwebvh-server"
fullnameOverride: "didwebvh-server"

selectorLabels: {}

ingress:
  tls: []
  labels: []
  annotations: []

networkPolicy:
  ingress:
    namespaceSelector: []

server:
  image:
    repository: ghcr.io/decentralized-identity/didwebvh-server-py
    tag: 0.5.0
    pullPolicy: IfNotPresent
    pullSecrets: []

  host: example.com

  workers: 4

  # Policies should be configured according to governance decisions
  policies:
    webvh_version: "1.0"
    webvh_witness: "true"
    webvh_watcher: ""
    webvh_prerotation: "true"
    webvh_portability: "true"
    webvh_endorsement: "true"
    webvh_known_witness_key: ""
    webvh_known_registry_url: ""

  branding:
    app_name: "DID WebVH Server"
    app_description: "An api server to register and serve web dids with verifiable history."
    icon: "https://didwebvh.info/latest/assets/favicon.ico"
    logo_vertical: "https://raw.githubusercontent.com/decentralized-identity/didwebvh-info/main/docs/assets/didwebvh.jpg"
    logo_horizontal: "https://raw.githubusercontent.com/decentralized-identity/didwebvh-info/main/docs/assets/didwebvh.jpg"
    app_primary_color: "#1a365d"
    app_secondary_color: "#38a169"
    app_accent_color: "#3182ce"

  replicaCount: 1

  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext: {}

  service:
    type: ClusterIP
    apiPort: 8000
    servicePort: 8000

  networkPolicy:
    ingress:
      podSelector: {}

# CloudPirates Postgres subchart (replaces Bitnami PostgreSQL)
# Uses official postgres image; see README for migration from Bitnami.
# Application connects as custom user webvh-admin (not the superuser).
postgres:
  enabled: true
  fullnameOverride: "didwebvh-server-postgres"

  auth:
    username: "didwebvh-server"
    database: "didwebvh-server"
    # Chart-managed secret (see templates/server/database-secret.yaml)
    existingSecret: "didwebvh-server-postgres"
    secretKeys:
      adminPasswordKey: postgres-password

  # Dedicated application user and DB (chart creates both; we add schema grants in initdb.scripts)
  customUser:
    name: "webvh-admin"
    database: "webvh"
    existingSecret: "didwebvh-server-postgres"
    secretKeys:
      name: user
      database: database
      password: password

  config:
    postgresql:
      max_connections: 500

  service:
    port: 5432

  persistence:
    enabled: true
    size: 1Gi

  initdb:
    scripts:
      01-init.sh: |
        #!/bin/bash
        set -e
        echo "Initializing database permissions for user: $CUSTOM_USER"
        export PGPASSWORD="$POSTGRES_PASSWORD"
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$CUSTOM_DB" <<-EOSQL
            CREATE EXTENSION IF NOT EXISTS pgcrypto;
            ALTER DATABASE "$CUSTOM_DB" OWNER TO "$CUSTOM_USER";
            REVOKE ALL ON SCHEMA public FROM PUBLIC;
            GRANT ALL ON SCHEMA public TO "$CUSTOM_USER";
            ALTER DEFAULT PRIVILEGES FOR USER "$CUSTOM_USER" IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "$CUSTOM_USER";
            ALTER DEFAULT PRIVILEGES FOR USER "$CUSTOM_USER" IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO "$CUSTOM_USER";
            ALTER DEFAULT PRIVILEGES FOR USER "$CUSTOM_USER" IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO "$CUSTOM_USER";
        EOSQL
        echo "Database initialization complete for user: $CUSTOM_USER"

  # Relax security context for compatibility; tighten as needed
  podSecurityContext:
    fsGroup: 999
  containerSecurityContext:
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 999
    runAsGroup: 999
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
